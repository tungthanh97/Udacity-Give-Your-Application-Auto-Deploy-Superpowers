---
- name: "Creates backend app directory"
  file:
    path: ~/backend-app
    state: directory
    mode: 0755
    
- name: "remove lock files"
  shell: |
    sudo rm /var/lib/apt/lists/lock
    sudo rm /var/cache/apt/archives/lock
    sudo rm /var/lib/dpkg/lock*

- name: "Install dependencies"
  become: true
  apt:
    name: ["nodejs", "npm"]
    state: "latest"

- name: "Install pm2"
  become: true
  npm:
    name: "pm2"
    global: yes
    production: yes
    state: "present"

- name: "Unarchive backend files"
  unarchive:
    src: artifact.tar.gz
    dest: ~/backend-app

# - name: "Installing Node Dependencies"
#   shell: |
#     cd ~/backend-app
#     npm i

- name: "executing node"
  shell: |
    cd ~/backend-app/backend
    pm2 stop default
    sudo pm2 start npm --name udapeople -- start
    npm start

# - name: "Executing Node app with PM2"
#   shell: |
#     cd ~/backend-app/dist
#     pm2 stop default
#     pm2 start main.js
#   register: execute_node

# - name: print message
#   debug:
#     msg: "{{ execute_node.stdout_lines }}"
  
- name: "Configure pm2 to start as service"
  shell: |
    sudo su -c "env PATH=$PATH:/usr/local/bin pm2 startup systemd -u ubuntu --hp /home/ubuntu"
    pm2 save
